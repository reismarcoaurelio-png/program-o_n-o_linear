<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Simplex KKT Dinâmico - Passo a Passo</title>
<style>
body{font-family:Arial,sans-serif;padding:18px;background:#f7f9fb;color:#111}
h1,h2{margin-bottom:12px}
.input-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px;}
input[type="text"]{padding:6px 8px;border-radius:6px;border:1px solid #cbd5e1;width:80px;text-align:right}
input.basicVar{width:60px;text-align:center}
button{padding:8px 12px;border-radius:6px;border:none;cursor:pointer;background:#2563eb;color:white;margin-top:5px}
table{border-collapse:collapse;margin-top:12px}
th,td{border:1px solid #999;padding:6px;text-align:center}
td.correct{background:#dcfce7;color:#065f46}
td.wrong{background:#fee2e2;color:#9b1c1c}
.status{padding:8px;border-radius:6px;margin-top:10px}
.ok{background:#dcfce7;color:#065f46}
.error{background:#fee2e2;color:#9b1c1c}
</style>
</head>
<body>

<h1>Simplex KKT - Passo a Passo</h1>

<h2>Problema:</h2>
<p id="problemText">
Maximizar z = -x1² + 6x1 - 2x2² + 8x2<br>
Sujeito a:<br>
2x1 + 4x2 ≤ 8<br>
x1 ≥ 0, x2 ≥ 0
</p>

<div class="input-row">
<label>Aluno:</label>
<input id="studentName" type="text" placeholder="Digite seu nome"/>
<button id="startBtn">Iniciar</button>
</div>

<div id="iterationsArea"></div>
<div id="feedback" class="status">Clique em "Iniciar" para gerar a primeira tabela.</div>
<button id="downloadPdf" style="display:none;">Baixar Relatório PDF</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// Variáveis globais
let studentName = '';
let tableaux = [];
let currentIter = 0;
let scores = [];
const varNames = ['x1','x2','x3','y1','y2','y3'];

// Funções utilitárias
function parseInput(val){
  val = val.trim();
  if(!val) return NaN;
  if(val.includes('/')){
    const parts = val.split('/');
    return parseFloat(parts[0])/parseFloat(parts[1]);
  } else {
    return parseFloat(val);
  }
}

function isCorrect(valAluno, valCorreto){
  return Math.abs(parseInput(valAluno) - valCorreto) < 1e-6;
}

// Classe Simplex KKT
class SimplexKKT {
  constructor(){
    this.base = ['x3','y1','y2']; // Base inicial
    this.A = [
      [2,4,1,0,0,0],
      [-2,0,0,1,0,-2],
      [0,-4,0,0,1,-4]
    ];
    this.b = [8,-6,-8];
    this.iterations = [];
    this.saveIteration();
  }

  saveIteration(){
    const Acopy = this.A.map(row=>[...row]);
    const bcopy = [...this.b];
    const baseCopy = [...this.base];
    this.iterations.push({baseVars:baseCopy,A:Acopy,b:bcopy});
  }

  nextIteration(){
    // Encontra candidato a entrar: primeira coluna fora da base mais negativa
    let entering=-1; let mostNeg=0;
    for(let j=0;j<varNames.length;j++){
      if(!this.base.includes(varNames[j])){
        let val=0;
        for(let i=0;i<this.A.length;i++){
          if(this.base[i].startsWith('y')) val+=this.A[i][j];
        }
        if(val<mostNeg){ mostNeg=val; entering=j; }
      }
    }
    if(entering===-1) return false; // ótimo atingido

    // Determina saída: complementar da que entra
    const leaving=this.base.findIndex(bv=>{
      return (bv.startsWith('x') && 'y'+bv.slice(1)===varNames[entering])||
             (bv.startsWith('y') && 'x'+bv.slice(1)===varNames[entering]);
    });
    if(leaving===-1) return false;

    // Pivot simplificado: apenas troca base para o aluno preencher
    this.base[leaving]=varNames[entering];
    this.saveIteration();
    return true;
  }
}

// Inicialização
let simplex=null;
function start(){
  studentName = document.getElementById('studentName').value.trim();
  if(!studentName){ alert('Digite seu nome!'); return; }

  simplex = new SimplexKKT();
  // Gera iterações até o ótimo
  while(simplex.nextIteration()){}
  tableaux = simplex.iterations;
  currentIter=0;
  scores=[];
  renderIteration(currentIter);
  document.getElementById('feedback').innerText='Preencha a primeira tabela e clique em "Verificar Iteração".';
}

// Renderiza tabela da iteração
function renderIteration(idx){
  const iter = tableaux[idx];
  const area = document.getElementById('iterationsArea');
  const div = document.createElement('div');
  div.className='iteration';
  div.innerHTML = `<strong>Iteração ${idx+1}:</strong>`;
  const tbl = document.createElement('table');

  const thead = document.createElement('thead');
  const htr = document.createElement('tr');
  htr.innerHTML = '<th>Base</th>' + varNames.map(v=>`<th>${v}</th>`).join('') + '<th>b</th>';
  thead.appendChild(htr);
  tbl.appendChild(thead);

  const tbody = document.createElement('tbody');
  for(let i=0;i<iter.baseVars.length;i++){
    const tr = document.createElement('tr');
    const tdBase=document.createElement('td');
    const inputBase=document.createElement('input');
    inputBase.type='text'; inputBase.className='basicVar'; inputBase.dataset.row=i;
    tdBase.appendChild(inputBase);
    tr.appendChild(tdBase);

    for(let j=0;j<varNames.length;j++){
      const td=document.createElement('td');
      const input=document.createElement('input');
      input.type='text'; input.dataset.row=i; input.dataset.col=j;
      td.appendChild(input); tr.appendChild(td);
    }

    const tdB=document.createElement('td');
    const inputB=document.createElement('input');
    inputB.type='text'; inputB.dataset.row=i; inputB.dataset.b=true;
    tdB.appendChild(inputB); tr.appendChild(tdB);

    tbody.appendChild(tr);
  }
  tbl.appendChild(tbody);
  div.appendChild(tbl);

  const btn=document.createElement('button');
  btn.innerText='Verificar Iteração';
  btn.addEventListener('click',()=>checkIteration(idx,div,tbl));
  div.appendChild(btn);
  area.appendChild(div);
}

// Verifica tabela preenchida pelo aluno
function checkIteration(idx,div,tbl){
  const iter=tableaux[idx];
  let correct=0,total=0;

  // Base
  const inputsBase=tbl.querySelectorAll('input.basicVar');
  inputsBase.forEach((inp,i)=>{
    total++;
    if(inp.value.trim()===iter.baseVars[i]) inp.parentElement.className='correct', correct++;
    else inp.parentElement.className='wrong';
  });

  // Coeficientes
  for(let i=0;i<iter.baseVars.length;i++){
    for(let j=0;j<varNames.length;j++){
      total++;
      const inp=tbl.querySelector(`input[data-row='${i}'][data-col='${j}']`);
      if(isCorrect(inp.value, iter.A[i][j])) inp.parentElement.className='correct', correct++;
      else inp.parentElement.className='wrong';
    }
  }

  // b
  for(let i=0;i<iter.baseVars.length;i++){
    total++;
    const inp=tbl.querySelector(`input[data-row='${i}'][data-b]`);
    if(isCorrect(inp.value, iter.b[i])) inp.parentElement.className='correct', correct++;
    else inp.parentElement.className='wrong';
  }

  scores[idx]=Math.round(100*correct/total);

  const fb=document.getElementById('feedback');
  fb.innerText=`Iteração ${idx+1}: ${correct}/${total} valores corretos. Nota: ${scores[idx]}%`;
  fb.className='status '+(correct===total?'ok':'error');

  if(idx+1<tableaux.length){
    currentIter++;
    renderIteration(currentIter);
  } else {
    fb.innerText += " ✅ Todas as iterações completadas!";
    document.getElementById('downloadPdf').style.display='inline-block';
  }
}

// PDF
document.getElementById('downloadPdf').addEventListener('click',()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text(`Aluno: ${studentName}`, 10, 10);
  tableaux.forEach((t,i)=>{
    doc.text(`Iteração ${i+1}: Nota ${scores[i]}%`,10,20+i*10);
  });
  const avg=Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);
  doc.text(`Nota final: ${avg}%`,10,40+tableaux.length*10);
  doc.save(`relatorio_${studentName.replace(/\s/g,'_')}.pdf`);
});

document.getElementById('startBtn').addEventListener('click',start);
</script>
</body>
</html>
